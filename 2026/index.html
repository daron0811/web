<div id="mindar-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;">
    <video id="mindar-video" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>
</div>

<div id="GameDiv" cc_exact_fit_screen="true">
    <div id="Cocos3dGameContainer">
      <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="99"></canvas>
    </div>
</div>

<script type="module">
  import { Controller } from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js';

  window.addEventListener('load', () => {

    const videoElement = document.getElementById('mindar-video');
    
    // 步驟 1: 開啟攝影機的函式
    const startCamera = async () => {
      // 請求後鏡頭權限
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { 
          facingMode: 'environment' 
        },
        audio: false
      });

      videoElement.srcObject = stream;
      
      // 等待 metadata 載入，確保我們能拿到 videoWidth/videoHeight
      return new Promise((resolve) => {
        videoElement.onloadedmetadata = () => {
          videoElement.play();
          resolve(videoElement);
        };
      });
    };

    // 步驟 2: 主啟動流程
    const startAR = async () => {
        try {
            console.log("正在開啟攝影機...");
            await startCamera(); 
            
            // ★ 關鍵修正：拿到攝影機尺寸後，才初始化 Controller
            const { videoWidth, videoHeight } = videoElement;
            console.log(`攝影機尺寸: ${videoWidth}x${videoHeight}`);

            const mindarController = new Controller({
                inputWidth: videoWidth,
                inputHeight: videoHeight,
                maxTrack: 1, 
                // 減少抖動參數
                filterMinCF: 0.0001, 
                filterBeta: 0.001,
            });

            // ★ 步驟 3: 手動載入識別圖並等待完成
            console.log("正在載入識別圖...");
            const { dimensions } = await mindarController.addImageTargets('./targets.mind');
            console.log("識別圖載入完成", dimensions);

            // ★ 步驟 4: 開始處理影像
            console.log("開始 AR 運算...");
            await mindarController.processVideo(videoElement);

            // 監聽更新
            mindarController.onUpdate = (data) => {
                const anchor = mindarController.getAnchor(0);
                
                if (anchor && anchor.visible) {
                    const event = new CustomEvent('mindar-update', {
                        detail: {
                            visible: true,
                            matrix: anchor.matrix
                        }
                    });
                    window.dispatchEvent(event);
                } else {
                    const event = new CustomEvent('mindar-update', {
                        detail: { visible: false }
                    });
                    window.dispatchEvent(event);
                }
            };

        } catch (error) {
            console.error("MindAR 啟動失敗:", error);
        }
    }

    // 執行
    // 為了相容性，建議加一個按鈕讓使用者點擊，目前先自動執行測試
    startAR();
  });
</script>
<div id="mindar-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;">
</div>

<div id="GameDiv" cc_exact_fit_screen="true">
    <div id="Cocos3dGameContainer">
      <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="99"></canvas>
    </div>
</div>

<script type="module">
  // 直接從 CDN import 需要的 Controller 類別
  import { Controller } from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js';

  window.addEventListener('load', () => {
    
    // 1. 初始化 Controller (注意：這邊直接用 Controller，不用 window.MINDAR)
    const mindarController = new Controller({
      imageTargetSrc: './targets.mind', 
      maxTrack: 1, 
    });

    const startAR = async () => {
      const container = document.querySelector("#mindar-container");
      
      try {
        // 2. Setup 會回傳建立好的 video 元素
        const { video, dimensions } = await mindarController.setup(container);
        
        // 3. 等待影片播放
        await video.play();
        
        // 4. 開始處理影像辨識
        mindarController.processVideo(video);

        // 5. 每一幀更新時觸發
        mindarController.onUpdate = (renderInfo) => {
          const anchor = mindarController.getAnchor(0); // 取得第一個識別圖的資訊
          
          // 發送 CustomEvent 給 Cocos Creator
          const event = new CustomEvent('mindar-update', {
            detail: {
              visible: anchor && anchor.visible,
              matrix: anchor ? anchor.matrix : null
            }
          });
          window.dispatchEvent(event);
        };
      } catch (error) {
        console.error("MindAR 啟動失敗:", error);
      }
    }

    // 建議：你可以做一個 "Start AR" 的按鈕讓使用者點擊後再執行 startAR()
    // 這樣可以避免 iOS Safari 阻擋自動播放 Video
    startAR();
  });
</script>
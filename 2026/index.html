<div id="mindar-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;">
    <video id="mindar-video" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>
</div>

<script type="module">
  import { Controller } from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js';

  window.addEventListener('load', async () => {
    
    // 1. 初始化 Controller
    const mindarController = new Controller({
      imageTargetSrc: './targets.mind', 
      maxTrack: 1, 
      // 可以在這裡設定 filterMinCF, filterBeta 來減少抖動
      filterMinCF: 0.001, 
      filterBeta: 1000,
    });

    const videoElement = document.getElementById('mindar-video');

    // 2. 手動開啟鏡頭的函式
    const startCamera = async () => {
      try {
        // 請求鏡頭權限 (使用後鏡頭 environment)
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment' 
          },
          audio: false
        });

        videoElement.srcObject = stream;
        
        // 等待影片載入完成
        await new Promise((resolve) => {
          videoElement.onloadedmetadata = () => {
            videoElement.play();
            resolve();
          };
        });
        
        return videoElement;
      } catch (err) {
        console.error("無法開啟鏡頭:", err);
        alert("無法開啟鏡頭，請確認瀏覽器權限或是否使用 HTTPS");
        throw err;
      }
    };

    // 3. 啟動 AR 流程
    const startAR = async () => {
        try {
            await startCamera(); // 等待鏡頭開啟

            // 取得影片實際尺寸，告訴 Controller
            const { videoWidth, videoHeight } = videoElement;
            
            // ★ 關鍵修正：Raw Controller 使用 processVideo 來啟動運算
            // 它沒有 setup 方法，直接餵影片給它
            await mindarController.processVideo(videoElement);

            // 4. 監聽更新 (每一幀)
            mindarController.onUpdate = (data) => {
                // data 包含 type: 'update'
                const anchor = mindarController.getAnchor(0); // 取得第一個圖
                
                if (anchor && anchor.visible) {
                    const event = new CustomEvent('mindar-update', {
                        detail: {
                            visible: true,
                            matrix: anchor.matrix
                        }
                    });
                    window.dispatchEvent(event);
                } else {
                    const event = new CustomEvent('mindar-update', {
                        detail: { visible: false }
                    });
                    window.dispatchEvent(event);
                }
            };

        } catch (error) {
            console.error("MindAR 啟動失敗:", error);
        }
    }

    // 執行
    // 建議：如果是 iOS，最好做一個按鈕讓使用者點擊後才呼叫 startAR()
    startAR();
  });
</script>
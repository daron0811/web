<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <title>Cocos Creator | MD-Tunnel</title>

  <meta name="viewport"
        content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1,minimal-ui=true"/>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">

  <meta name="renderer" content="webkit"/>
  <meta name="force-rendering" content="webkit"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="msapplication-tap-highlight" content="no">

  <meta name="full-screen" content="yes"/>
  <meta name="x5-fullscreen" content="true"/>
  <meta name="360-fullscreen" content="true"/>
  <meta name="x5-page-mode" content="app">

  <link rel="stylesheet" type="text/css" href="style.css"/>
</head>

<body>
  <div id="GameDiv" cc_exact_fit_screen="true">
    <div id="Cocos3dGameContainer">
      <canvas id="GameCanvas"
              oncontextmenu="event.preventDefault()"
              tabindex="99"></canvas>
    </div>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    
    // ğŸ‘‡ [NEW] æ–°å¢ï¼šå¼•å…¥ Auth ç›¸é—œåŠŸèƒ½
    import { 
      getAuth, 
      signInAnonymously 
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    import {
      getDatabase,
      ref,
      push,
      set,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
		apiKey: "AIzaSyC7udEN-Jdxw3_mNbpMSUBV6LQ743rp5-4",
		authDomain: "madou-tunnel.firebaseapp.com",
		databaseURL: "https://madou-tunnel-default-rtdb.asia-southeast1.firebasedatabase.app",
		projectId: "madou-tunnel",
		storageBucket: "madou-tunnel.firebasestorage.app",
		messagingSenderId: "786743617812",
		appId: "1:786743617812:web:cf6f49040a2f4016ddfa01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // ğŸ‘‡ [NEW] æ–°å¢ï¼šåˆå§‹åŒ– Auth ä¸¦åŸ·è¡ŒåŒ¿åç™»å…¥
    const auth = getAuth(app);
    signInAnonymously(auth)
      .then(() => {
        console.log('[Firebase] Web ç«¯åŒ¿åç™»å…¥æˆåŠŸï¼');
      })
      .catch((error) => {
        console.error('[Firebase] ç™»å…¥å¤±æ•—ï¼š', error);
      });

    // ğŸ”¥ å°å¤–æ©‹æ¥çµ¦ Cocos ä½¿ç”¨
    window.__firebaseReady = true;
    window.firebaseService = {
      async sendMessage(type, text) {
        // ğŸ‘‡ [å»ºè­°] æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼Œé›–ç„¶ Firebase SDK æœƒè‡ªå‹•è™•ç† tokenï¼Œä½†é€™æ¨£æ¯”è¼ƒä¿éšª
        if (!auth.currentUser) {
            console.warn('[Firebase] å°šæœªç™»å…¥ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯');
            return null;
        }

        const msg = (text || '').trim();
        if (!msg) return null;

        const listRef = ref(db, `messages/${type}`);
        const newRef = push(listRef);
        await set(newRef, {
          text: msg,
          createdAt: serverTimestamp()
        });
        return newRef.key;
      }
    };

    console.log('[Firebase] ready');
  </script>

  <!-- âš ï¸ é€™ä¸€è¡Œä¸€å®šè¦ç•™åœ¨æœ€å¾Œ -->
  

<!-- Polyfills bundle. -->

<script src="src/polyfills.bundle.js" charset="utf-8"> </script>


<!-- SystemJS support. -->
<script src="src/system.bundle.js" charset="utf-8"> </script>

<!-- Import map -->
<script src="src/import-map.json" type="systemjs-importmap" charset="utf-8"> </script>

<script>
    System.import('./index.js').catch(function(err) { console.error(err); })
</script>

</body>
</html>
